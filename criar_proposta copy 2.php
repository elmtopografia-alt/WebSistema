<?php
// Nome da p√°gina: criar_proposta.php
// VERS√ÉO: FINAL E COMPAT√çVEL COM O NOVO BACKEND

require_once 'db.php';
mysqli_report(MYSQLI_REPORT_ERROR | MYSQLI_REPORT_STRICT);

try {
    $clientes_res = $conn->query("SELECT id_cliente, nome_cliente, telefone, celular FROM Clientes ORDER BY nome_cliente ASC");
    $servicos_res = $conn->query("SELECT id_servico, nome, descricao FROM Tipo_Servicos ORDER BY nome ASC");
    $estados = [];
    $result_estados = $conn->query("SELECT nome, sigla FROM estados ORDER BY nome ASC");
    while ($row = $result_estados->fetch_assoc()) { $estados[] = $row; }
    $tipos_funcao = [];
    $result = $conn->query("SELECT id_funcao, nome, salario_base_default FROM Tipo_Funcoes ORDER BY nome ASC");
    while ($row = $result->fetch_assoc()) { $tipos_funcao[] = $row; }
    $tipos_estadia = [];
    $result = $conn->query("SELECT id_estadia, nome, valor_unitario_default FROM Tipo_Estadia ORDER BY nome ASC");
    while ($row = $result->fetch_assoc()) { $tipos_estadia[] = $row; }
    $tipos_consumo = [];
    $result = $conn->query("SELECT id_consumo, nome, valor_litro_default, consumo_kml_default FROM Tipo_Consumo ORDER BY nome ASC");
    while ($row = $result->fetch_assoc()) { $tipos_consumo[] = $row; }
    $tipos_locacao = [];
    $result = $conn->query("SELECT id_locacao, nome, valor_mensal_default FROM Tipo_Locacao ORDER BY nome ASC");
    while ($row = $result->fetch_assoc()) { $tipos_locacao[] = $row; }
    $tipos_admin = [];
    $result = $conn->query("SELECT id_custo_admin, nome, valor_default FROM Tipo_Custo_Admin ORDER BY nome ASC");
    while ($row = $result->fetch_assoc()) { $tipos_admin[] = $row; }
    $marcas_por_tipo = [];
    $result_marcas = $conn->query("SELECT id_marca, id_locacao, nome_marca FROM Marcas ORDER BY nome_marca ASC");
    while ($row = $result_marcas->fetch_assoc()) {
        $marcas_por_tipo[$row['id_locacao']][] = $row;
    }
} catch (mysqli_sql_exception $e) { 
    die("<div class='alert alert-danger m-5'><h1>Erro de Conex√£o:</h1><p>" . htmlspecialchars($e->getMessage()) . "</p></div>"); 
}
?>
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Nova Proposta | ELM Topografia</title>
    <link rel="preconnect" href="https://fonts.googleapis.com"><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" /><link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    <style>
        body { background-color: #f4f6fa; font-family: 'Inter', sans-serif; padding-top: 70px; padding-bottom: 80px; } .app-navbar { background-color: #1e293b; box-shadow: 0 4px 10px rgba(0,0,0,0.1); height: 60px; } .navbar-title { color: white; font-weight: 600; letter-spacing: 0.5px; } .paper-container { max-width: 900px; margin: 0 auto; } .section-card { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); margin-bottom: 24px; overflow: hidden; } .section-header { background-color: #f8fafc; padding: 16px 24px; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 12px; } .section-title { font-size: 1.1rem; font-weight: 700; color: #334155; margin: 0; } .section-icon { color: #3b82f6; background: #dbeafe; width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; } .section-body { padding: 24px; } .form-floating > .form-control, .form-floating > .form-select { border-radius: 8px; border: 1px solid #cbd5e1; height: calc(3.5rem + 2px); } .form-floating > .form-control:focus { border-color: #3b82f6; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); } .table-custom thead th { background-color: #f1f5f9; color: #64748b; font-size: 0.85rem; text-transform: uppercase; font-weight: 700; border-top: none; } .table-custom td { vertical-align: middle; } .btn-add-item { font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; border-radius: 6px; padding: 8px 16px; } .finance-summary { background-color: #f8fafc; border-radius: 12px; padding: 20px; border: 1px dashed #cbd5e1; } .final-price-box { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border: 1px solid #bfdbfe; border-radius: 12px; padding: 20px; text-align: right; } .price-label { font-size: 0.9rem; color: #64748b; font-weight: 600; text-transform: uppercase; margin-bottom: 5px; } .price-value { font-size: 2.5rem; color: #2563eb; font-weight: 800; line-height: 1; } .save-bar { margin-top: 30px; display: flex; justify-content: center; } .btn-save-big { padding: 15px 40px; font-size: 1.1rem; font-weight: 700; border-radius: 50px; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3); transition: all 0.3s; } .btn-save-big:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4); } .select2-container--bootstrap-5 .select2-selection { border-radius: 8px; border-color: #cbd5e1; min-height: 58px; display: flex; align-items: center; } .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered { padding-top: 15px; padding-left: 12px; color: #212529; font-size: 1rem; }
        #painel-sucesso { display: none; text-align: center; padding: 40px 20px; } .success-icon { font-size: 5rem; color: #198754; margin-bottom: 20px; animation: bounceIn 0.8s; } @keyframes bounceIn { 0% { transform: scale(0.3); opacity: 0; } 50% { transform: scale(1.05); opacity: 1; } 70% { transform: scale(0.9); } 100% { transform: scale(1); } }
    </style>
</head>
<body>
    <nav class="navbar fixed-top app-navbar">
        <div class="container-fluid"><div class="d-flex align-items-center"><a href="index.php" class="btn btn-outline-light border-0 me-2 btn-sm"><i class="fas fa-arrow-left"></i> Voltar</a></div><span class="navbar-title mx-auto"><i class="fa-solid fa-file-signature me-2"></i>Nova Proposta</span><div style="width: 70px;"></div></div>
    </nav>
    <div class="container paper-container">
        <?php if (isset($_SESSION['modo_demo']) && $_SESSION['modo_demo'] === true): ?><div class="alert alert-warning text-center mb-4 fw-bold">üöß MODO DEMONSTRA√á√ÉO - Dados ser√£o apagados em breve.</div><?php endif; ?>
        <div id="painel-sucesso" class="section-card"><div class="success-icon"><i class="fa-solid fa-circle-check"></i></div><h2 class="fw-bold text-dark mb-3">Proposta Gerada com Sucesso!</h2><p class="text-muted mb-5">O download do arquivo Word deve come√ßar automaticamente.<br>O que voc√™ deseja fazer agora?</p><div class="d-flex justify-content-center gap-3"><a href="index.php" class="btn btn-outline-primary btn-lg px-4"><i class="fa-solid fa-layer-group me-2"></i> Voltar ao Gerenciador</a><a href="logout.php" class="btn btn-outline-danger btn-lg px-4"><i class="fa-solid fa-power-off me-2"></i> Fechar e Sair</a></div></div>
        <div id="area-formulario">
            <form action="salvar_proposta.php" method="POST" id="form-proposta" target="iframe-download">
                <div class="section-card"><div class="section-header"><div class="section-icon"><i class="fa-solid fa-address-card"></i></div><h2 class="section-title">Dados do Cliente & Obra</h2></div><div class="section-body"><div class="row g-3"><div class="col-md-6"><div class="form-floating"><select class="form-select" name="id_cliente" id="id_cliente" required><option value="">Selecione...</option><?php mysqli_data_seek($clientes_res, 0); while ($cliente = $clientes_res->fetch_assoc()): $textoContato = trim(explode(' ', $cliente['nome_cliente'])[0] . ' ' . $cliente['telefone'] . ' ' . $cliente['celular']);?><option value="<?= $cliente['id_cliente']; ?>" data-contato="<?= htmlspecialchars($textoContato); ?>"><?= htmlspecialchars($cliente['nome_cliente']); ?></option><?php endwhile; ?></select><label for="id_cliente">Cliente</label></div></div><div class="col-md-6"><div class="form-floating"><select class="form-select" name="id_servico" id="id_servico" required><option value="">Selecione...</option><?php mysqli_data_seek($servicos_res, 0); while ($servico = $servicos_res->fetch_assoc()): ?><option value="<?= $servico['id_servico']; ?>" data-descricao="<?= htmlspecialchars($servico['descricao']); ?>"><?= htmlspecialchars($servico['nome']); ?></option><?php endwhile; ?></select><label for="id_servico">Modelo de Servi√ßo</label></div></div><div class="col-12"><div class="form-floating"><textarea class="form-control" name="finalidade" id="finalidade" placeholder="Desc" style="height: 80px"></textarea><label for="finalidade">Descri√ß√£o / Escopo do Servi√ßo</label></div></div></div><hr class="text-muted opacity-25 my-4"><h6 class="text-muted text-uppercase fw-bold mb-3" style="font-size: 0.75rem;">Detalhes da Obra</h6><div class="row g-3"><div class="col-md-4"><div class="form-floating"><input type="text" class="form-control" name="contato_obra" id="contato_obra"><label>Contato na Obra</label></div></div><div class="col-md-4"><div class="form-floating"><input type="text" class="form-control" name="tipo_levantamento" id="tipo_levantamento"><label>Tipo Levantamento</label></div></div><div class="col-md-4"><div class="form-floating"><input type="text" class="form-control" name="area_obra" id="area_obra"><label>√Årea (m¬≤ / ha)</label></div></div><div class="col-md-6"><div class="form-floating"><input type="text" class="form-control" name="endereco_obra" id="endereco_obra"><label>Endere√ßo</label></div></div><div class="col-md-3"><div class="form-floating"><input type="text" class="form-control" name="cidade_obra" id="cidade_obra"><label>Cidade</label></div></div><div class="col-md-3"><div class="form-floating"><select class="form-select" name="estado_obra" id="estado_obra"><?php foreach ($estados as $est): ?><option value="<?= $est['sigla']; ?>" <?= $est['sigla'] == 'MG' ? 'selected' : ''; ?>><?= $est['sigla']; ?></option><?php endforeach; ?></select><label>UF</label></div></div></div><hr class="text-muted opacity-25 my-4"><div class="row g-3"><div class="col-4"><div class="form-floating"><input type="number" class="form-control" name="dias_campo" id="dias_campo" value="1"><label>Dias Campo</label></div></div><div class="col-4"><div class="form-floating"><input type="number" class="form-control" name="dias_escritorio" id="dias_escritorio" value="4"><label>Dias Escrit√≥rio</label></div></div><div class="col-4"><div class="form-floating"><input type="text" class="form-control" name="prazo_execucao" id="prazo_execucao" value="5 dias"><label>Prazo Total</label></div></div></div></div></div>
                <div class="section-card"><div class="section-header"><div class="section-icon"><i class="fa-solid fa-calculator"></i></div><h2 class="section-title">Composi√ß√£o de Custos</h2></div><div class="section-body bg-light"><div class="accordion" id="accordion-custos"><div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-salarios">Equipe & Sal√°rios</button></h2><div id="collapse-salarios" class="accordion-collapse collapse show" data-bs-parent="#accordion-custos"><div class="accordion-body"><div class="table-responsive"><table class="table table-custom table-hover"><thead><tr><th>Fun√ß√£o</th><th>Qtd</th><th>Sal√°rio Base</th><th>Encargos</th><th>Dias</th><th>Total</th><th></th></tr></thead><tbody id="tbody-salarios"></tbody></table></div><div class="d-flex justify-content-between align-items-center mt-2"><button type="button" class="btn btn-outline-primary btn-add-item" id="add-salario">+ Profissional</button><div class="fw-bold fs-5 text-dark" id="total-secao-salarios">R$ 0,00</div></div></div></div></div><div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-estadia">Estadia & Alimenta√ß√£o</button></h2><div id="collapse-estadia" class="accordion-collapse collapse" data-bs-parent="#accordion-custos"><div class="accordion-body"><div class="table-responsive"><table class="table table-custom table-hover"><thead><tr><th>Tipo</th><th>Qtd</th><th>Valor Unit.</th><th>Dias</th><th>Total</th><th></th></tr></thead><tbody id="tbody-estadia"></tbody></table></div><div class="d-flex justify-content-between align-items-center mt-2"><button type="button" class="btn btn-outline-primary btn-add-item" id="add-estadia">+ Item</button><div class="fw-bold fs-5 text-dark" id="total-secao-estadia">R$ 0,00</div></div></div></div></div><div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-consumos">Combust√≠vel</button></h2><div id="collapse-consumos" class="accordion-collapse collapse" data-bs-parent="#accordion-custos"><div class="accordion-body"><div class="table-responsive"><table class="table table-custom table-hover"><thead><tr><th>Tipo</th><th>Qtd</th><th>Km/L</th><th>R$/Litro</th><th>Km Total</th><th>Total</th><th></th></tr></thead><tbody id="tbody-consumos"></tbody></table></div><div class="d-flex justify-content-between align-items-center mt-2"><button type="button" class="btn btn-outline-primary btn-add-item" id="add-consumo">+ Combust√≠vel</button><div class="fw-bold fs-5 text-dark" id="total-secao-consumos">R$ 0,00</div></div></div></div></div><div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-locacao">Loca√ß√£o & Equipamentos</button></h2><div id="collapse-locacao" class="accordion-collapse collapse" data-bs-parent="#accordion-custos"><div class="accordion-body"><div class="table-responsive"><table class="table table-custom table-hover"><thead><tr><th>Equipamento</th><th>Modelo/Marca</th><th>Qtd</th><th>Mensal</th><th>Dias</th><th>Total</th><th></th></tr></thead><tbody id="tbody-locacao"></tbody></table></div><div class="d-flex justify-content-between align-items-center mt-2"><button type="button" class="btn btn-outline-primary btn-add-item" id="add-locacao">+ Equipamento</button><div class="fw-bold fs-5 text-dark" id="total-secao-locacao">R$ 0,00</div></div></div></div></div><div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-admin">Custos Administrativos</button></h2><div id="collapse-admin" class="accordion-collapse collapse" data-bs-parent="#accordion-custos"><div class="accordion-body"><div class="table-responsive"><table class="table table-custom table-hover"><thead><tr><th>Item</th><th>Qtd</th><th>Valor</th><th>Total</th><th></th></tr></thead><tbody id="tbody-admin"></tbody></table></div><div class="d-flex justify-content-between align-items-center mt-2"><button type="button" class="btn btn-outline-primary btn-add-item" id="add-admin">+ Custo</button><div class="fw-bold fs-5 text-dark" id="total-secao-admin">R$ 0,00</div></div></div></div></div></div></div></div>
                <div class="section-card border-primary border-opacity-25"><div class="section-header bg-primary bg-opacity-10"><div class="section-icon bg-primary text-white"><i class="fa-solid fa-sack-dollar"></i></div><h2 class="section-title text-primary">Fechamento Financeiro</h2></div><div class="section-body"><div class="row"><div class="col-lg-7"><div class="finance-summary mb-3"><div class="d-flex justify-content-between mb-2"><span class="text-muted">Custo Operacional Total:</span><span class="fw-bold" id="total-custos-geral">R$ 0,00</span></div><hr class="my-2 opacity-25"><div class="row align-items-center mb-2"><div class="col-6 text-muted">Margem de Lucro (%):</div><div class="col-6 d-flex align-items-center justify-content-end"><input type="number" class="form-control form-control-sm w-25 me-2 text-end border-success" id="percentual-lucro" name="percentual_lucro" value="30"><span class="text-success fw-bold small" id="valor-lucro">+ R$ 0,00</span></div></div><div class="d-flex justify-content-between mb-2 fw-bold text-dark"><span>Subtotal:</span><span id="subtotal-com-lucro">R$ 0,00</span></div><div class="row align-items-center"><div class="col-6 text-muted">Desconto Comercial (R$):</div><div class="col-6 d-flex justify-content-end"><input type="number" class="form-control form-control-sm w-50 text-end text-danger" id="valor-desconto" name="valor_desconto" value="0" step="0.01"></div></div></div><h6 class="text-muted text-uppercase fw-bold mt-4 mb-3" style="font-size: 0.75rem;">Condi√ß√µes de Pagamento</h6><div class="row g-2"><div class="col-md-6"><div class="input-group input-group-sm"><span class="input-group-text bg-light">Entrada %</span><input type="number" class="form-control text-end" id="mobilizacao_percentual" name="mobilizacao_percentual" value="30"><span class="input-group-text fw-bold text-primary" id="mobilizacao_valor">R$ 0,00</span></div></div><div class="col-md-6"><div class="input-group input-group-sm"><span class="input-group-text bg-light">Restante %</span><span class="form-control text-end bg-white" id="restante_percentual">70</span><span class="input-group-text fw-bold text-secondary" id="restante_valor">R$ 0,00</span></div></div></div></div><div class="col-lg-5 mt-4 mt-lg-0"><div class="final-price-box h-100 d-flex flex-column justify-content-center"><div class="price-label">Valor Final da Proposta</div><div class="price-value" id="valor-final-proposta">R$ 0,00</div><div class="mt-3 text-center text-muted small"><i class="fa-solid fa-check-circle me-1 text-success"></i> Impostos inclusos</div></div></div></div></div></div>
                <div class="save-bar"><input type="hidden" name="total_custos_salarios" id="hidden_total_custos_salarios"><input type="hidden" name="total_custos_estadia" id="hidden_total_custos_estadia"><input type="hidden" name="total_custos_consumos" id="hidden_total_custos_consumos"><input type="hidden" name="total_custos_locacao" id="hidden_total_custos_locacao"><input type="hidden" name="total_custos_admin" id="hidden_total_custos_admin"><input type="hidden" name="valor_lucro" id="hidden_valor_lucro"><input type="hidden" name="subtotal_com_lucro" id="hidden_subtotal_com_lucro"><input type="hidden" name="valor_final_proposta" id="hidden_valor_final_proposta"><input type="hidden" name="mobilizacao_valor" id="hidden_mobilizacao_valor"><input type="hidden" name="restante_percentual" id="hidden_restante_percentual"><input type="hidden" name="restante_valor" id="hidden_restante_valor"><button type="submit" class="btn btn-primary btn-save-big"><i class="fas fa-file-contract me-2"></i> Gerar Proposta em Word</button></div>
            </form>
        </div> 
    </div>
    <iframe name="iframe-download" style="display: none;"></iframe>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script><script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        const opcoesFuncaoHtml = `<?php foreach ($tipos_funcao as $item): ?><option value="<?php echo $item['id_funcao']; ?>" data-valor="<?php echo $item['salario_base_default']; ?>"><?php echo htmlspecialchars($item['nome']); ?></option><?php endforeach; ?>`;
        const opcoesEstadiaHtml = `<?php foreach ($tipos_estadia as $item): ?><option value="<?php echo $item['id_estadia']; ?>" data-valor="<?php echo $item['valor_unitario_default']; ?>"><?php echo htmlspecialchars($item['nome']); ?></option><?php endforeach; ?>`;
        const opcoesConsumoHtml = `<?php foreach ($tipos_consumo as $item): ?><option value="<?php echo $item['id_consumo']; ?>" data-valor-litro="<?php echo $item['valor_litro_default']; ?>" data-consumo-kml="<?php echo $item['consumo_kml_default']; ?>"><?php echo htmlspecialchars($item['nome']); ?></option><?php endforeach; ?>`;
        const opcoesLocacaoHtml = `<?php foreach ($tipos_locacao as $item): ?><option value="<?php echo $item['id_locacao']; ?>" data-valor="<?php echo $item['valor_mensal_default']; ?>"><?php echo htmlspecialchars($item['nome']); ?></option><?php endforeach; ?>`;
        const opcoesAdminHtml = `<?php foreach ($tipos_admin as $item): ?><option value="<?php echo $item['id_custo_admin']; ?>" data-valor="<?php echo $item['valor_default']; ?>"><?php echo htmlspecialchars($item['nome']); ?></option><?php endforeach; ?>`;
        const marcasPorTipo = <?php echo json_encode($marcas_por_tipo); ?>;
    </script>
    <script src="calculos.js?v=<?php echo time(); ?>"></script>
    <script>
        $(document).ready(function() {
            $('#id_cliente, #id_servico').select2({ theme: "bootstrap-5", width: '100%', placeholder: "Selecione..." });
            $('#id_cliente').on('select2:select', function(e) { var contato = $(e.params.data.element).data('contato'); $('#contato_obra').val(contato); });
            $('#id_servico').on('change', function() { var option = $(this).find('option:selected'); var descricao = option.data('descricao'); if(!$('#finalidade').val()) { $('#finalidade').val(descricao); } var textoSelect = option.text().trim(); $('#tipo_levantamento').val("Levantamento " + textoSelect); });
            $('#form-proposta').on('submit', function() {
                var btnSalvar = $(this).find('button[type="submit"]');
                btnSalvar.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span> Gerando Documento...');
                setTimeout(function() { window.scrollTo({ top: 0, behavior: 'smooth' }); $('#area-formulario').fadeOut(600, function() { $('#painel-sucesso').fadeIn(600); }); }, 4000); 
            });
        });
    </script>
</body>
</html>
*Fim arquivo criar_proposta.php*